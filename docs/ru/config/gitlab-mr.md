# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitLab MR

TerraCi –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã terraform plan –≤ –≤–∏–¥–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ Merge Request –≤ GitLab.

## –û–±–∑–æ—Ä

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ GitLab MR, TerraCi:
1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–≤–æ–¥ terraform plan –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
2. –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ summary-–¥–∂–æ–±–µ
3. –ü—É–±–ª–∏–∫—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ MR —Å–æ —Å–≤–æ–¥–∫–æ–π –≤—Å–µ—Ö –ø–ª–∞–Ω–æ–≤

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```yaml
gitlab:
  mr:
    comment:
      enabled: true
    summary_job:
      image:
        name: "ghcr.io/edelwud/terraci:latest"
```

### –í—Å–µ –æ–ø—Ü–∏–∏

```yaml
gitlab:
  mr:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    comment:
      # –í–∫–ª—é—á–∏—Ç—å MR –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: true, –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è mr —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
      enabled: true
      # –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: false)
      on_changes_only: false
      # –í–∫–ª—é—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥ –ø–ª–∞–Ω–∞ –≤ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è —Å–µ–∫—Ü–∏—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: true)
      include_details: true

    # –ú–µ—Ç–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ MR (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã)
    labels:
      - "terraform"
      - "env:{environment}"
      - "service:{service}"

    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è summary job
    summary_job:
      # Docker-–æ–±—Ä–∞–∑ —Å terraci
      image:
        name: "ghcr.io/edelwud/terraci:latest"
      # –¢–µ–≥–∏ —Ä–∞–Ω–Ω–µ—Ä–∞
      tags:
        - docker
```

## –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –≤ –º–µ—Ç–∫–∞—Ö

–ú–µ—Ç–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è:

| –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-------------|----------|--------|
| `{service}` | –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ | `platform` |
| `{environment}` | –û–∫—Ä—É–∂–µ–Ω–∏–µ | `production` |
| `{env}` | –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è environment | `prod` |
| `{region}` | –†–µ–≥–∏–æ–Ω –æ–±–ª–∞–∫–∞ | `eu-central-1` |
| `{module}` | –ò–º—è –º–æ–¥—É–ª—è | `vpc` |

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü–ª–∞–Ω-–¥–∂–æ–±—ã

–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π MR-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω-–¥–∂–æ–±—ã –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –¥–ª—è:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–ª–∞–≥–∞ `-detailed-exitcode` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ñ–∞–π–ª `plan.txt`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `plan.txt` –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (—Å `when: always`)

```yaml
plan-platform-stage-eu-central-1-vpc:
  script:
    - cd platform/stage/eu-central-1/vpc
    - ${TERRAFORM_BINARY} init
    - ${TERRAFORM_BINARY} plan -out=plan.tfplan -detailed-exitcode 2>&1 | tee plan.txt; exit ${PIPESTATUS[0]}
  artifacts:
    paths:
      - platform/stage/eu-central-1/vpc/plan.tfplan
      - platform/stage/eu-central-1/vpc/plan.txt
    expire_in: 1 day
    when: always
```

### 2. Summary Job

–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∂–æ–± `terraci-summary`, –∫–æ—Ç–æ—Ä—ã–π:
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø–ª–∞–Ω-–¥–∂–æ–±–æ–≤
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ MR-–ø–∞–π–ø–ª–∞–π–Ω–∞—Ö (`$CI_MERGE_REQUEST_IID`)
- –°–∫–∞–Ω–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã `plan.txt` –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
- –ü—É–±–ª–∏–∫—É–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ MR —á–µ—Ä–µ–∑ GitLab API

```yaml
terraci-summary:
  stage: summary
  image: ghcr.io/edelwud/terraci:latest
  script:
    - terraci summary
  needs:
    - job: plan-platform-stage-eu-central-1-vpc
      optional: true
  rules:
    - if: $CI_MERGE_REQUEST_IID
      when: always
```

### 3. –§–æ—Ä–º–∞—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è

–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ MR –≤–∫–ª—é—á–∞–µ—Ç:
- –¢–∞–±–ª–∏—Ü—É-–æ–±–∑–æ—Ä —Å –∏–∫–æ–Ω–∫–∞–º–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥—É–ª–µ–π —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏/–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π/—Å –æ—à–∏–±–∫–∞–º–∏
- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –¥–µ—Ç–∞–ª–∏ —Å –ø–æ–ª–Ω—ã–º –≤—ã–≤–æ–¥–æ–º –ø–ª–∞–Ω–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)

–ü—Ä–∏–º–µ—Ä:
```
## üîÑ Terraform Plan Summary

| –ú–æ–¥—É–ª—å | –°—Ç–∞—Ç—É—Å | –°–≤–æ–¥–∫–∞ |
|--------|--------|--------|
| `platform/stage/eu-central-1/vpc` | ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è | Plan: 2 to add, 1 to change, 0 to destroy |
| `platform/stage/eu-central-1/eks` | ‚ûñ –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π | Infrastructure is up-to-date |

<details>
<summary>üìã platform/stage/eu-central-1/vpc</summary>

```
Plan: 2 to add, 1 to change, 0 to destroy.
...
```

</details>
```

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

Summary job —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω GitLab API:

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CI_JOB_TOKEN

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `CI_JOB_TOKEN` —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è MR –≤ —Ç–æ–º –∂–µ –ø—Ä–æ–µ–∫—Ç–µ:
```yaml
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GITLAB_TOKEN

–î–ª—è –∫—Ä–æ—Å—Å-–ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö MR –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤:
```yaml
variables:
  GITLAB_TOKEN: $GITLAB_API_TOKEN
```

–¢—Ä–µ–±—É–µ–º—ã–µ –ø—Ä–∞–≤–∞: `api` –∏–ª–∏ `write_repository`

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

Summary job –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ CI/CD –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `CI_MERGE_REQUEST_IID` | –ù–æ–º–µ—Ä MR (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) |
| `CI_PROJECT_ID` | ID –ø—Ä–æ–µ–∫—Ç–∞ (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) |
| `CI_PROJECT_PATH` | –ü—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) |
| `GITLAB_TOKEN` | API —Ç–æ–∫–µ–Ω (–æ—Ç–∫–∞—Ç –∫ `CI_JOB_TOKEN`) |

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ MR-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞:
   ```yaml
   gitlab:
     mr:
       comment:
         enabled: true
   ```

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–ø—É—â–µ–Ω –∏–∑ MR:
   ```bash
   echo $CI_MERGE_REQUEST_IID
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞:
   ```bash
   curl -H "PRIVATE-TOKEN: $GITLAB_TOKEN" \
     "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID"
   ```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–ª–∞–Ω–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã plan.txt —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö:
   ```bash
   find . -name "plan.txt"
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–ª–∞–Ω-–¥–∂–æ–±—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å (–¥–∞–∂–µ —Å –æ—à–∏–±–∫–∞–º–∏):
   ```yaml
   artifacts:
     when: always  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   ```

### Summary job –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

Summary job –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
1. MR-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ (—Å–µ–∫—Ü–∏—è `gitlab.mr` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
2. –ü–ª–∞–Ω—ã –≤–∫–ª—é—á–µ–Ω—ã (`gitlab.plan_enabled: true`)
