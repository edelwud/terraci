stages:
  - test
  - build
  - release

variables:
  GO_VERSION: "1.22"
  GORELEASER_VERSION: "v2.4.4"
  # Artifactory Docker registry URL (override in CI/CD settings)
  # Example: artifactory.example.com/docker-local
  DOCKER_REGISTRY: ${ARTIFACTORY_DOCKER_REGISTRY}

default:
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git make

# Cache Go modules
.go-cache: &go-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
    policy: pull-push
  variables:
    GOPATH: ${CI_PROJECT_DIR}/.go

# ------------------------------------------------------------------------------
# Test stage
# ------------------------------------------------------------------------------

lint:
  stage: test
  <<: *go-cache
  image: golangci/golangci-lint:v1.62-alpine
  script:
    - golangci-lint run --timeout 5m
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:
  stage: test
  <<: *go-cache
  script:
    - go mod download
    - go test -race -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ------------------------------------------------------------------------------
# Build stage
# ------------------------------------------------------------------------------

build:
  stage: build
  <<: *go-cache
  script:
    - go mod download
    - make build
    - ./terraci version
  artifacts:
    paths:
      - terraci
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Snapshot build for main branch (not tagged)
snapshot:
  stage: build
  <<: *go-cache
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache git curl
    - curl -sL https://github.com/goreleaser/goreleaser/releases/download/${GORELEASER_VERSION}/goreleaser_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin goreleaser
  script:
    - docker login -u ${ARTIFACTORY_USER} -p ${ARTIFACTORY_PASSWORD} ${DOCKER_REGISTRY}
    - goreleaser release --snapshot --clean
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: true

# ------------------------------------------------------------------------------
# Release stage
# ------------------------------------------------------------------------------

release:
  stage: release
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    GITLAB_TOKEN: ${CI_JOB_TOKEN}
  before_script:
    - apk add --no-cache git curl
    - curl -sL https://github.com/goreleaser/goreleaser/releases/download/${GORELEASER_VERSION}/goreleaser_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin goreleaser
  script:
    # Login to Artifactory Docker registry
    - docker login -u ${ARTIFACTORY_USER} -p ${ARTIFACTORY_PASSWORD} ${DOCKER_REGISTRY}
    # Run goreleaser
    - goreleaser release --clean
  artifacts:
    paths:
      - dist/
    expire_in: 4 weeks
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
